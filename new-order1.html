<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Raju Courses - Dashboard</title>
  <style>
    /* [ Same CSS Styling From Original Code ] */
    /* Keep All Styles as-is from your original page */
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>RajuCourses</h2>
    <ul>
      <li><a href="new-order1.html" aria-current="page">üéì Buy Course</a></li>
      <li><a href="my-orders.html">üì¶ My Courses</a></li>
<li><a href="new-order.html">üì¶ Buy Services</a></li>
      <li><a href="services.html">üìö All Courses</a></li>
      <li><a href="register-complaint.html">üõ†Ô∏è Support</a></li>
    </ul>
  </div>

  <div class="main">
    <div class="card">
      <h1>Buy Your Course</h1>
      <form id="serviceForm">
        <div class="form-group">
          <label for="category">Course Type</label>
          <select id="category"></select>
        </div>
        <div class="form-group">
          <label for="service">Course Package</label>
          <select id="service"></select>
        </div>
        <div class="form-group">
          <label for="link">Your Instagram / Email</label>
          <input type="text" id="link" placeholder="Enter contact (Instagram/email)" required />
        </div>
        <div class="form-group">
          <label for="quantity">Quantity</label>
          <input type="number" id="quantity" placeholder="Enter number of licenses (1 or more)" required />
        </div>
        <div class="form-group">
          <label for="charge">Total Charge</label>
          <input type="text" id="charge" readonly />
        </div>
        <div class="form-group">
          <label>Scan & Pay via:</label>
          <img src="qr.png" alt="Pay via QR Code" style="max-width: 300px; display: block; margin: 10px auto;" />
          <p style="text-align: center; color: #1e293b; font-weight: 500;">
            Paytm | GPay | FamPay | BharatPe | BHIM UPI<br>
            <small style="color: #64748b;">(All-in-one QR ‚Äì Just Pay and click submit button to verify)</small>
          </p>
        </div>
        <button type="submit" class="submit-btn">Submit</button>
      </form>
    </div>
  </div>

  <script>
    const services = {
      raju_courses: [
        { name: "Viral Hack Guide", rate: 159 },
        { name: "Prompt PDF Guide", rate: 180 },
        { name: "1 Month Plan (No Debit Card) ‚Äì 6 Videos/Day + Guide", rate: 200 },
        { name: "1 Month Plan (With Debit Card) ‚Äì Unlimited Videos + Prompt PDF", rate: 348 },
        { name: "1.5 Year Plan (With Debit Card) ‚Äì Unlimited + Prompt PDF", rate: 699 },
        { name: "Ultimate Pack ‚Äì All-in-One + Private Guidance", rate: 799 }
      ]
    };

    const categorySelect = document.getElementById("category");
    const serviceSelect = document.getElementById("service");
    const quantityInput = document.getElementById("quantity");
    const chargeInput = document.getElementById("charge");

    function updateCharge() {
      const category = categorySelect.value;
      const selectedIndex = serviceSelect.value;
      const quantity = parseInt(quantityInput.value) || 0;
      if (services[category] && services[category][selectedIndex]) {
        const rate = services[category][selectedIndex].rate;
        const charge = quantity * rate;
        chargeInput.value = `‚Çπ${charge.toFixed(2)}`;
      }
    }

    categorySelect.addEventListener("change", () => {
      const selected = categorySelect.value;
      serviceSelect.innerHTML = "";
      services[selected].forEach((service, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.text = `${service.name} ‚Äì ‚Çπ${service.rate}`;
        serviceSelect.appendChild(option);
      });
      updateCharge();
    });

    serviceSelect.addEventListener("change", updateCharge);
    quantityInput.addEventListener("input", updateCharge);

    // Initialize Category Dropdown
    Object.keys(services).forEach(key => {
      const option = document.createElement("option");
      option.value = key;
      option.text = key.replace(/_/g, " ").toUpperCase();
      categorySelect.appendChild(option);
    });
    categorySelect.dispatchEvent(new Event("change"));

    // Submit Handler
    document.getElementById('serviceForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const submitButton = this.querySelector("button[type='submit']");
      submitButton.disabled = true;
      submitButton.textContent = "Submitting...";

      try {
        const confirmation = confirm("Have you paid the amount via QR?");
        if (!confirmation) {
          alert("Please complete the payment before submitting.");
          return;
        }

        const category = categorySelect.value;
        const serviceIndex = serviceSelect.value;
        const quantity = parseInt(quantityInput.value);
        const link = document.getElementById("link").value.trim();

        if (!link || !/^.+$/i.test(link)) {
          alert("Please enter a valid contact (Instagram/email).");
          return;
        }

        if (isNaN(quantity) || quantity <= 0) {
          alert("Enter a valid quantity (1 or more).");
          return;
        }

        const serviceObj = services[category][serviceIndex];

        const order = {
          service: serviceObj.name,
          link,
          quantity,
          category,
          timestamp: new Date().toISOString()
        };

        const lastOrderKey = `${category}-${serviceIndex}-${link}-${quantity}`;
        if (sessionStorage.getItem(lastOrderKey)) {
          alert("You've already submitted this order recently.");
          return;
        }
        sessionStorage.setItem(lastOrderKey, "submitted");

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch("https://smmp-backend-l4dc.onrender.com/new-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          signal: controller.signal,
          body: JSON.stringify(order)
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`);
        }

        const existingOrders = JSON.parse(localStorage.getItem("orders")) || [];
        existingOrders.push(order);
        localStorage.setItem("orders", JSON.stringify(existingOrders));

        alert("Course access submitted successfully!");
        window.location.href = "my-orders.html";

      } catch (error) {
        if (error.name === "AbortError") {
          alert("Please wait... or try refreshing if already paid.");
        } else {
          console.error("Error:", error);
          alert("Failed to submit order.");
        }
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = "Submit";
      }
    });
  </script>
</body>
</html>
